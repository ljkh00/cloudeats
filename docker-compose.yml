services:
  # ============================================
  # DATABASES (Shared Infrastructure)
  # ============================================
  
  # MySQL Database
  db:
    image: mysql:8.0
    container_name: cloudeats-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: cloudeats_db
      MYSQL_USER: cloudeats_user
      MYSQL_PASSWORD: cloudeats_password
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - cloudeats-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: cloudeats-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - cloudeats-network
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  # MongoDB
  mongodb:
    image: mongo:7
    container_name: cloudeats-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin_password
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - cloudeats-network

  # ============================================
  # MICROSERVICES
  # ============================================

  # User Microservice (Port 3001)
  user-service:
    build: ./services/user-service
    container_name: user-service
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - DB_HOST=db
      - DB_USER=cloudeats_user
      - DB_PASSWORD=cloudeats_password
      - DB_NAME=cloudeats_db
      - PORT=3001
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cloudeats-network
    labels:
      - "service.name=user-service"
      - "service.description=Authentication and user profiles"

  # Menu Microservice (Port 3002)
  menu-service:
    build: ./services/menu-service
    container_name: menu-service
    restart: unless-stopped
    ports:
      - "3002:3002"
    environment:
      - DB_HOST=db
      - DB_USER=cloudeats_user
      - DB_PASSWORD=cloudeats_password
      - DB_NAME=cloudeats_db
      - PORT=3002
    depends_on:
      db:
        condition: service_healthy
    networks:
      - cloudeats-network
    labels:
      - "service.name=menu-service"
      - "service.description=Menu items and catalog"

  # Order Microservice (Port 3003)
  order-service:
    build: ./services/order-service
    container_name: order-service
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      - REDIS_HOST=redis
      - MONGO_HOST=mongodb
      - MONGO_USER=admin
      - MONGO_PASSWORD=admin_password
      - PORT=3003
    depends_on:
      - redis
      - mongodb
    networks:
      - cloudeats-network
    labels:
      - "service.name=order-service"
      - "service.description=Shopping cart and orders"

  # ============================================
  # API GATEWAY (NEW!)
  # ============================================
  
  api-gateway:
    build: ./services/api-gateway
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "8000:8000"  # Main entry point!
    environment:
      - USER_SERVICE_URL=http://user-service:3001
      - MENU_SERVICE_URL=http://menu-service:3002
      - ORDER_SERVICE_URL=http://order-service:3003
      - PORT=8000
    depends_on:
      - user-service
      - menu-service
      - order-service
    networks:
      - cloudeats-network
    labels:
      - "service.name=api-gateway"
      - "service.description=Main entry point for all API requests"

  # ============================================
  # FRONTEND
  # ============================================
  
  web:
    build: ./frontend
    container_name: cloudeats-web
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - api-gateway
    networks:
      - cloudeats-network

# ============================================
# NETWORKS
# ============================================
networks:
  cloudeats-network:
    driver: bridge
    name: cloudeats-network

# ============================================
# VOLUMES
# ============================================
volumes:
  db_data:
    name: cloudeats-db-data
  redis_data:
    name: cloudeats-redis-data
  mongo_data:
    name: cloudeats-mongo-data